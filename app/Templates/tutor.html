{% extends 'base.html' %}

{% block title %}
AI Tutor - {{ topic }}
{% endblock %}

{% block content %}
<div class="container-fluid my-3">
    <div class="row">
        <div class="col-md-3">
            <div class="card modern-card">
                <div class="card-header modern-card-header">
                    <h5 class="mb-0"><i class="fas fa-book-open me-2"></i>Module Information</h5>
                </div>
                <div class="card-body">
                    <h6 class="text-primary-emphasis fw-bold">{{ phase.name }}</h6>
                    <span class="badge modern-badge-info"><i class="fas fa-calendar-week me-1"></i> Week {{
                        module.week }}</span>

                    <div class="mt-3">
                        <h6 class="fw-semibold">Learning Objectives:</h6>
                        <ul class="list-styled ps-3">
                            {% for objective in module.learning_objectives %}
                            <li>{{ objective }}</li>
                            {% endfor %}
                        </ul>
                    </div>

                    <div class="mt-3">
                        <h6 class="fw-semibold">Key Skills:</h6>
                        <div class="d-flex flex-wrap gap-2">
                            {% for skill in phase.skills %}
                            <span class="badge modern-badge-skill">{{ skill }}</span>
                            {% endfor %}
                        </div>
                    </div>

                    <hr class="my-3">

                    <a href="{{ url_for('roadmap_bp.roadmap') }}" class="btn btn-secondary-modern w-100 mb-2">
                        <i class="fas fa-arrow-left me-2"></i> Back to Roadmap
                    </a>
                    <button class="btn btn-danger-modern w-100" id="btnClearChat">
                        <i class="fas fa-trash-alt me-2"></i> Clear Chat History
                    </button>
                </div>
            </div>

            <div class="card modern-card mt-3">
                <div class="card-header modern-card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Learning Resources</h5>
                    <button class="btn btn-sm btn-light-modern" id="btnRefreshResources" title="Refresh Resources">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                <div class="card-body p-0">
                    <ul class="nav nav-tabs modern-tabs" id="resourceTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="videos-tab" data-bs-toggle="tab"
                                data-bs-target="#videos" type="button" role="tab" aria-controls="videos"
                                aria-selected="true"><i class="fas fa-video me-1"></i> Videos</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="papers-tab" data-bs-toggle="tab" data-bs-target="#papers"
                                type="button" role="tab" aria-controls="papers" aria-selected="false"><i
                                    class="fas fa-file-alt me-1"></i> Papers</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="web-tab" data-bs-toggle="tab" data-bs-target="#web"
                                type="button" role="tab" aria-controls="web" aria-selected="false"><i
                                    class="fas fa-globe me-1"></i> Web</button>
                        </li>
                    </ul>
                    <div class="tab-content" id="resourceTabsContent">
                        <div class="tab-pane fade show active resources-scrollable" id="videos" role="tabpanel"
                            aria-labelledby="videos-tab">
                            <div class="loading-spinner" id="videosLoading">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="mt-2">Loading videos...</p>
                            </div>
                            <div id="videosList" class="p-3"></div>
                        </div>
                        <div class="tab-pane fade resources-scrollable" id="papers" role="tabpanel"
                            aria-labelledby="papers-tab">
                            <div class="loading-spinner" id="papersLoading">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="mt-2">Loading papers...</p>
                            </div>
                            <div id="papersList" class="p-3"></div>
                        </div>
                        <div class="tab-pane fade resources-scrollable" id="web" role="tabpanel"
                            aria-labelledby="web-tab">
                            <div class="loading-spinner" id="webLoading">
                                <div class="spinner-border text-primary" role="status"></div>
                                <p class="mt-2">Loading web resources...</p>
                            </div>
                            <div id="webList" class="p-3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-9">
            <div class="card modern-card chat-card-container">
                <div class="card-header modern-card-header">
                    <h5 class="mb-0"><i class="fas fa-robot me-2"></i>AI Tutor - {{ topic }}</h5>
                </div>
                
                <div id="chatContainer" class="chat-container card-body">
                    {% if chat_history|length > 0 %}
                    {% for message in chat_history %}
                    <div class="chat-message {{ 'user-message' if message.role == 'user' else 'ai-message' }}">
                        <div class="message-content" data-formatted="false">
                            {{ message.content|safe }}
                        </div>
                        <div class="message-timestamp">
                            {{ message.timestamp.strftime('%Y-%m-%d %H:%M') if message.timestamp else 'Unknown time' }}
                        </div>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="chat-message ai-message">
                        <div class="message-content">
                            <p>ðŸ‘‹ Hi there! I'm your AI tutor for <strong>{{ topic }}</strong>.</p>
                            <p>I'm here to help you understand the concepts, answer your questions, and guide you
                                through this learning module. Feel free to ask me anything about:</p>
                            <ul>
                                {% for objective in module.learning_objectives %}
                                <li>{{ objective }}</li>
                                {% endfor %}
                            </ul>
                            <p>What would you like to learn about today?</p>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <div id="typingIndicator" class="chat-message ai-message typing-indicator d-none">
                    <div class="message-content">
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>

                <div class="chat-form-container card-footer">
                    <form id="chatForm" class="chat-form d-flex gap-2">
                        <input type="text" id="messageInput" class="form-control chat-input"
                            placeholder="Type your question here..." required>
                        <button type="submit" class="btn btn-send-gradient">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* --- Card Styling --- */
    .modern-card {
        border: var(--card-border, 1px solid #e2e8f0);
        box-shadow: var(--card-shadow, 0 8px 25px rgba(99, 102, 241, 0.1));
        border-radius: 16px;
        overflow: hidden; /* Ensures header radius is clean */
    }

    .modern-card-header {
        background: var(--primary-gradient, linear-gradient(45deg, #6366f1, #a78bfa));
        color: white;
        padding: 1rem 1.5rem;
    }

    .modern-card-header h5 {
        font-weight: 600;
    }
    
    .list-styled {
        padding-left: 20px;
    }
    .list-styled li {
        margin-bottom: 0.5rem;
    }

    /* --- Badge Styling --- */
    .modern-badge-info {
        background-color: #e0e7ff; /* light indigo */
        color: #4338ca; /* dark indigo */
        font-size: 0.85rem;
        font-weight: 600;
        padding: 0.4em 0.7em;
    }
    .modern-badge-skill {
        background: #f1f5f9; /* light gray */
        color: #334155; /* dark gray */
        font-size: 0.8rem;
        font-weight: 500;
        padding: 0.4em 0.7em;
    }

    /* --- Button Styling --- */
    .btn-secondary-modern {
        background-color: #f1f5f9;
        color: #334155;
        font-weight: 600;
        border: none;
        transition: all 0.2s ease;
    }
    .btn-secondary-modern:hover {
        background-color: #e2e8f0;
        color: #1e293b;
    }
    .btn-danger-modern {
        background-color: #fee2e2; /* light red */
        color: #b91c1c; /* dark red */
        font-weight: 600;
        border: none;
        transition: all 0.2s ease;
    }
    .btn-danger-modern:hover {
        background-color: #fecaca;
        color: #991b1b;
    }
    .btn-light-modern {
        background-color: white;
        color: var(--primary-color-start, #6366f1);
        border: 1px solid #e2e8f0;
        border-radius: 50%;
        width: 35px;
        height: 35px;
    }
    .btn-light-modern:hover {
        background-color: #f8f9fa;
        transform: rotate(45deg);
    }
    
    /* --- Resource Tabs --- */
    .modern-tabs {
        border-bottom: 2px solid #e2e8f0;
        padding: 0.5rem 1rem 0 1rem;
    }
    .modern-tabs .nav-item {
        margin-bottom: -2px; /* Pulls tab up to overlap border */
    }
    .modern-tabs .nav-link {
        border: none;
        color: #4a5568;
        font-weight: 600;
        font-size: 0.9rem;
    }
    .modern-tabs .nav-link.active {
        color: var(--primary-color-start, #6366f1);
        border-bottom: 2px solid var(--primary-color-start, #6366f1);
        background-color: transparent;
    }
    .modern-tabs .nav-link:hover {
        color: var(--primary-color-start, #6366f1);
    }
    
    .loading-spinner {
        text-align: center;
        padding: 2rem;
        color: #6b7280;
    }
    
    /* --- Chat Card Layout --- */
    .chat-card-container {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 120px); /* Adjust as needed */
        max-height: 800px;
    }

    /* --- Chat Container --- */
    .chat-container {
        flex-grow: 1; /* Takes up available space */
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        padding: 1.5rem;
        background-color: #f8f9fa; /* Light background for chat area */
    }

    .chat-message {
        max-width: 80%;
        margin-bottom: 1rem;
        padding: 0.75rem 1.25rem;
        border-radius: 1.25rem;
        line-height: 1.6;
        word-wrap: break-word;
    }

    .user-message {
        align-self: flex-end;
        background: var(--primary-gradient, linear-gradient(45deg, #6366f1, #a78bfa));
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 0.25rem;
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
    }

    .ai-message {
        align-self: flex-start;
        background-color: #ffffff;
        color: #334155;
        margin-right: auto;
        border: 1px solid #e2e8f0;
        border-bottom-left-radius: 0.25rem;
    }

    .message-content {
        word-wrap: break-word;
    }
    .message-content p:last-child { margin-bottom: 0; }
    .message-content ul, .message-content ol { margin-top: 0.5rem; }
    
    /* Code block styling */
    .message-content pre {
        background-color: #1e293b; /* Dark bg */
        color: #e2e8f0;
        padding: 1rem;
        border-radius: 8px;
        overflow-x: auto;
        font-size: 0.9em;
        margin: 1rem 0;
    }
    .message-content pre code {
        background-color: transparent;
        color: inherit;
        padding: 0;
        font-family: 'Courier New', Courier, monospace;
    }
    .message-content code:not(pre *) {
        background-color: #e2e8f0;
        padding: 0.2em 0.4em;
        border-radius: 4px;
        font-size: 0.9em;
    }
    
    .message-timestamp {
        text-align: right;
        font-size: 0.75rem;
        margin-top: 0.5rem;
        opacity: 0.7;
    }
    .user-message .message-timestamp {
        color: #e0e7ff;
    }
    .ai-message .message-timestamp {
        color: #6b7280;
        text-align: left;
    }
    
    /* --- Typing Indicator --- */
    .typing-indicator {
        padding: 0.75rem 1.25rem;
    }

    .typing-dots span {
        height: 8px;
        width: 8px;
        margin: 0 1px;
        background-color: #94a3b8;
        border-radius: 50%;
        display: inline-block;
        animation: typing 1.4s infinite ease-in-out;
    }
    .typing-dots span:nth-child(1) { animation-delay: 0s; }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
        0%, 50%, 100% { transform: translateY(0px); }
        25% { transform: translateY(-5px); }
    }

    /* --- Chat Input Form --- */
    .chat-form-container {
        padding: 1rem 1.5rem;
        background-color: #ffffff;
        border-top: 1px solid #e2e8f0;
    }
    .chat-input {
        border-radius: 12px;
        border: 1px solid #ddd;
        padding: 0.85rem 1rem;
        transition: all 0.3s ease;
        background-color: #f8f9fa;
        resize: none;
        font-size: 1rem;
    }
    .chat-input:focus {
        border-color: var(--primary-color-start, #6366f1);
        box-shadow: 0 0 0 0.2rem rgba(99, 102, 241, 0.25);
        background-color: white;
    }
    .btn-send-gradient {
        background-image: var(--primary-gradient, linear-gradient(45deg, #6366f1, #a78bfa));
        border: none;
        color: white;
        font-weight: 600;
        padding: 0.75rem 1.25rem;
        border-radius: 12px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
    }
    .btn-send-gradient:hover {
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 7px 15px rgba(99, 102, 241, 0.4);
    }

    /* --- Resource Card --- */
    .resource-card {
        margin-bottom: 1rem;
        transition: all 0.2s ease;
        border: 1px solid #e2e8f0;
        border-radius: 12px;
    }
    .resource-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }
    .video-thumbnail {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
    }
    .resource-card .card-body { padding: 1rem; }
    .resource-card .card-title {
        font-size: 0.95rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        line-height: 1.4;
    }
    .resource-meta {
        font-size: 0.8rem;
        color: #6b7280;
    }
    
    /* Resource scrollable area */
    .resources-scrollable {
        max-height: 450px;
        overflow-y: auto;
        scrollbar-width: thin;
    }
    .resources-scrollable::-webkit-scrollbar { width: 6px; }
    .resources-scrollable::-webkit-scrollbar-track { background: #f1f1f1; }
    .resources-scrollable::-webkit-scrollbar-thumb {
        background: #a78bfa; /* Violet */
        border-radius: 10px;
    }
    .resources-scrollable::-webkit-scrollbar-thumb:hover { background: #8b5cf6; } /* Darker Violet */
</style>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const messageInput = document.getElementById('messageInput');
        const chatForm = document.getElementById('chatForm');
        const chatContainer = document.getElementById('chatContainer');
        const typingIndicator = document.getElementById('typingIndicator');
        const btnClearChat = document.getElementById('btnClearChat');
        const btnRefreshResources = document.getElementById('btnRefreshResources');

        // Phase and module IDs for API calls
        const phaseId = '{{ phase_id }}';
        const moduleId = '{{ module_id }}';
        const topic = '{{ topic }}';

        // Scroll chat to bottom
        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // --- FIXED MARKDOWN FORMATTING FUNCTION ---
        function formatMessage(message) {
            if (!message) return '';

            let html = message;

            // 1. Handle code blocks (must run first)
            html = html.replace(/```(\w*)\n([\s\S]*?)```/g, (match, language, code) => {
                const lang = language || 'plaintext';
                const escapedCode = code.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                return `<pre><code class="language-${lang}">${escapedCode.trim()}</code></pre>`;
            });

            // 2. Handle unordered lists
            html = html.replace(/^(?:- (.*))(?:\n(?:- (.*)))*/gm, (match) => {
                const items = match.split('\n').map(item => `<li>${item.substring(2)}</li>`).join('');
                return `<ul>${items}</ul>`;
            });

            // 3. Handle ordered lists
            html = html.replace(/^(?:\d+\. (.*))(?:\n(?:\d+\. (.*)))*/gm, (match) => {
                const items = match.split('\n').map(item => `<li>${item.replace(/^\d+\. /, '')}</li>`).join('');
                return `<ol>${items}</ol>`;
            });
            
            // 4. Handle headers (h3, h4)
            html = html.replace(/^### (.*?)$/gm, '<h3>$1</h3>');
            html = html.replace(/^#### (.*?)$/gm, '<h4>$1</h4>');

            // 5. Handle bold and italic
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');

            // 6. Handle inline code
            html = html.replace(/`([^`]+)`/g, '<code>$1</code>');

            // 7. Handle line breaks (only remaining newlines)
            html = html.replace(/\n/g, '<br>');

            return html;
        }
        
        // Function to highlight code
        function highlightAllCode() {
            if (typeof hljs !== 'undefined') {
                document.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            }
        }
        
        // When rendering existing chat history, format all messages
        document.querySelectorAll('.message-content').forEach(function (el) {
            if (el.getAttribute('data-formatted') !== 'true') {
                const content = el.innerHTML;
                el.innerHTML = formatMessage(content.trim()); // Trim whitespace
                el.setAttribute('data-formatted', 'true');
            }
        });
        highlightAllCode(); // Highlight existing code

        // Scroll to bottom and load resources on init
        scrollToBottom();
        loadResources();

        // Handle chat form submission
        chatForm.addEventListener('submit', function (e) {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (!message) return;
            
            addMessageToChat('user', message);
            messageInput.value = '';
            typingIndicator.classList.remove('d-none');
            scrollToBottom();

            fetch('/api/tutor/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: message,
                    phase_id: phaseId,
                    module_id: moduleId
                })
            })
            .then(response => response.json())
            .then(data => {
                typingIndicator.classList.add('d-none');
                if (data.status === 'success') {
                    addMessageToChat('assistant', data.response);
                } else {
                    addMessageToChat('assistant', 'Sorry, I encountered an error. Please try again.');
                    console.error('Error:', data.message);
                }
            })
            .catch(error => {
                typingIndicator.classList.add('d-none');
                addMessageToChat('assistant', 'Sorry, I encountered an error. Please try again.');
                console.error('Error:', error);
            });
        });

        // Add message to chat
        function addMessageToChat(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', role === 'user' ? 'user-message' : 'ai-message');
            
            const contentDiv = document.createElement('div');
            contentDiv.classList.add('message-content');
            contentDiv.innerHTML = formatMessage(content); // Format new message
            
            const timestampDiv = document.createElement('div');
            timestampDiv.classList.add('message-timestamp');
            
            const now = new Date();
            const formattedDate = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}-${now.getDate().toString().padStart(2, '0')} ${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}`;
            timestampDiv.textContent = formattedDate;

            messageDiv.appendChild(contentDiv);
            messageDiv.appendChild(timestampDiv);
            chatContainer.appendChild(messageDiv);
            
            highlightAllCode(); // Highlight new code blocks
            scrollToBottom();
        }

        // Clear chat history
        btnClearChat.addEventListener('click', function () {
            if (confirm('Are you sure you want to clear the chat history? This cannot be undone.')) {
                fetch('/api/tutor/clear-history', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phase_id: phaseId,
                        module_id: moduleId
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        chatContainer.innerHTML = '';
                        const welcomeMessage = `
                            <p>ðŸ‘‹ Hi there! I'm your AI tutor for <strong>${topic}</strong>.</p>
                            <p>I'm here to help you understand the concepts, answer your questions, and guide you through this learning module. What would you like to learn about today?</p>
                        `;
                        addMessageToChat('assistant', welcomeMessage);
                    } else {
                        alert('Error clearing chat history: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error clearing chat history');
                });
            }
        });

        // --- Load resources function ---
        function loadResources() {
            // Show loading spinners
            document.getElementById('videosLoading').classList.remove('d-none');
            document.getElementById('papersLoading').classList.remove('d-none');
            document.getElementById('webLoading').classList.remove('d-none');
            
            // Clear previous resources
            document.getElementById('videosList').innerHTML = '';
            document.getElementById('papersList').innerHTML = '';
            document.getElementById('webList').innerHTML = '';

            fetch(`/api/tutor/resources?topic=${encodeURIComponent(topic)}&type=all`)
                .then(response => {
                    if (!response.ok) { throw new Error(`HTTP error! status: ${response.status}`); }
                    return response.json();
                })
                .then(data => {
                    // Hide loading spinners
                    document.getElementById('videosLoading').classList.add('d-none');
                    document.getElementById('papersLoading').classList.add('d-none');
                    document.getElementById('webLoading').classList.add('d-none');

                    if (data.status === 'success') {
                        // Populate videos
                        const videosList = document.getElementById('videosList');
                        if (data.resources.youtube && data.resources.youtube.length > 0) {
                            data.resources.youtube.forEach(video => {
                                videosList.innerHTML += `
                                    <div class="card resource-card">
                                        <img src="${video.thumbnail}" class="video-thumbnail" alt="${video.title}">
                                        <div class="card-body">
                                            <h6 class="card-title">${video.title}</h6>
                                            <div class="resource-meta">
                                                <i class="fas fa-user"></i> ${video.channelTitle}
                                            </div>
                                            <a href="${video.url}" target="_blank" class="btn btn-sm btn-outline-primary mt-2">Watch</a>
                                        </div>
                                    </div>
                                `;
                            });
                        } else {
                            videosList.innerHTML = '<p class="text-muted p-3">No videos found</p>';
                        }

                        // Populate papers
                        const papersList = document.getElementById('papersList');
                        if (data.resources.papers && data.resources.papers.length > 0) {
                            data.resources.papers.forEach(paper => {
                                let authorsText = (paper.authors && Array.isArray(paper.authors)) ? paper.authors.join(', ') : 'Unknown';
                                papersList.innerHTML += `
                                    <div class="card resource-card">
                                        <div class="card-body">
                                            <h6 class="card-title">${paper.title}</h6>
                                            <div class="resource-meta">
                                                <i class="fas fa-users"></i> ${authorsText}
                                                <br>
                                                <i class="fas fa-calendar"></i> ${paper.year}
                                                <i class="fas fa-quote-right ms-2"></i> ${paper.citations} citations
                                            </div>
                                            <a href="${paper.url}" target="_blank" class="btn btn-sm btn-outline-primary mt-2">Read Paper</a>
                                        </div>
                                    </div>
                                `;
                            });
                        } else {
                            papersList.innerHTML = '<p class="text-muted p-3">No papers found</p>';
                        }

                        // Populate web resources
                        const webList = document.getElementById('webList');
                        if (data.resources.web && data.resources.web.length > 0) {
                            data.resources.web.forEach(resource => {
                                webList.innerHTML += `
                                    <div class="card resource-card">
                                        <div class="card-body">
                                            <h6 class="card-title">${resource.title}</h6>
                                            <p class="small">${resource.snippet}</p>
                                            <div class="resource-meta">
                                                <i class="fas fa-globe"></i> ${resource.displayLink}
                                            </div>
                                            <a href="${resource.link}" target="_blank" class="btn btn-sm btn-outline-primary mt-2">Visit</a>
                                        </div>
                                    </div>
                                `;
                            });
                        } else {
                            webList.innerHTML = '<p class="text-muted p-3">No web resources found</p>';
                        }
                    } else {
                        throw new Error(data.message || 'API returned an error');
                    }
                })
                .catch(error => {
                    console.error("Fetch error:", error);
                    document.getElementById('videosLoading').classList.add('d-none');
                    document.getElementById('papersLoading').classList.add('d-none');
                    document.getElementById('webLoading').classList.add('d-none');
                    
                    const errorMsg = `<p class="text-danger p-3">Error loading resources: ${error.message}</p>`;
                    document.getElementById('videosList').innerHTML = errorMsg;
                    document.getElementById('papersList').innerHTML = errorMsg;
                    document.getElementById('webList').innerHTML = errorMsg;
                });
        }

        // Refresh resources button
        btnRefreshResources.addEventListener('click', loadResources);
    });
</script>
{% endblock %}